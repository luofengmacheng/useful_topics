## redis(3.2.5)代码总体处理流程

redis首先是一个服务器程序，作为一个服务器程序，以main函数的角度看，它的处理流程跟常见的服务器流程是一致的，都会有以下几个步骤：

* 语言、时间等的环境设置
* 日志和信号处理
* 配置处理
* 创建套接字，并注册该套接字的回调函数
* 进入事件循环

其中，在事件循环中，会发生三种事件：

* 套接字可读并且该套接字就是初始创建的套接字，则调用accept()接受客户端的连接请求；
* 套接字可读并且该套接字不是初始创建的套接字，则调用recv()读取客户端的请求，并处理客户端的请求，将返回的数据写入该套接字对应的输出缓冲区；
* 套接字可写，则调用send()将对应的输出缓冲区的内容发送给客户端。

下面将根据上面的步骤讲解redis的处理流程：

### 1 环境设置

从代码上看redis主要进行以下设置：

* 调用setlocale()对排序和比较进行了设置(参数为空，表示根据环境设置)
* 设置zmalloc()的OOM处理函数
* 根据时间和PID设置字典的hash种子

### 2 配置处理

* 调用initServerConfig()。redis用一个大的结构体保存了所有的配置和相关运行时要使用的数据(例如，命令表server.commands)，使用这种方式，当用户没有指定配置文件时，可以用这些默认的配置。
* 处理命令行参数。redis将命令行分成了三种类型：(1) 第一个参数是版本或者帮助信息的展示(-v/--version/-h/--help)，则直接输出版本信息和帮助信息然后退出；(2) 第一个参数是配置文件，则保存配置文件的路径；(3) 参数是redis的配置，则将这些配置保存到临时变量中。
* 处理配置文件。如果配置了配置文件，则读取配置文件中的配置，然后将命令行中的参数跟配置文件中的配置合并，最后对合并后的配置进行分析，或者保存到redis的配置结构体，或者执行对应的操作。

### 3 初始化

通过调用initServer()初始化整个服务，包括套接字的创建和事件循环的初始化。

初始化完成以下几件事：

* 创建套接字，并设置回调函数，然后初始化事件结构体
* 创建redis数据库
* 创建三种事件的回调函数(定时任务、网络请求、unix本地套接字请求)

### 4 运行模式: protected、sentinal和supervised