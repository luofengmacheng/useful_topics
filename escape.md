## 前端开发中特殊字符的问题

任何语言环境下，都会有一些用于表示特定含义的字符，这些字符作为语言的内在特性，例如，URL中，用&作为参数的分割符。那么，当内容中也包含这些特殊字符时，就需要对这些字符进行转义或者编码。

### 1 html、javascript中对URL的处理

URL有一套自己的格式规范，它使用=分割参数的名字和值，使用&分割多个参数，那么当参数的值中也包含这些保留字符时，就需要对URL进行编码。

js提供了三套编解码函数：

<table>
	<tr>
		<td></td>
		<td>安全字符(不会进行编码的字符)</td>
	</tr>
	<tr>
		<td>escape</td>
		<td>*/@+-._0-9a-zA-Z</td>
	</tr>
	<tr>
		<td>encodeURI</td>
		<td>!#$&'()*+,/:;=?@-._~0-9a-zA-Z</td>
	</tr>
	<tr>
		<td>encodeURIComponent</td>
		<td>!'()*-._~0-9a-zA-Z</td>
	</tr>
</table>

其中，encodeURI/decodeURI可以对一个完整的URI进行编码，因此，其中的保留字符不会进行编码；而encodeURIComponent/decodeURIComponent是对URI中的组件进行编码，因此，对部分保留字也会进行编码。

### 2 php中对特殊字符的处理

同样的，在PHP中也有对URL中特殊字符处理的方法：

urlencode/urldecode函数分别可以对字符串进行编解码。

同时，需要注意的是，超全局变量$_GET和$_REQUEST已经被解码了，再次对$_GET和$_REQUEST调用urldecode会导致不可预计的后果，因此，后台在获取到数据后，可以直接使用，而无需调用urldecode。

PHP中还有另外一对处理特殊字符的方法：

rawurlencode/rawurldecode函数的功能与urlencode/urldecode类似，只是它们在处理空格时，rawurlencode会把空格编码为%20，而urlencode则会把空格编码为`+`。

### 3 mysql中对特殊字符的处理

场景：有时候，我们需要将一些参数保存到数据库中，常用的做法是，从前台获取数据后放到js对象中，然后传到后台，后台将接收到的数据转换为JSON字符串，再保存到mysql数据库中。

在这个场景中有两个问题：

* 问题1：json对象中的键如果也是从前台获取的，如果用户填写的字符串包含点，传到后台，后台就不能正确地转换为PHP对象。

例如，如果前台传递的是{"a":"b"}，后台会转换为PHP对象：array("a" => "b")；但是，如果前台传递的是{"a.c":"b"}，后台就会转换成：array([0] => "b")，也就是说，它不能正确地识别键。因此，这里应该在前端就将数据转换为JSON字符串。

* 问题2：如果传递的数据中包含特殊字符，JSON对象转成JSON字符串时会自动对特殊字符添加转义符号，但是，写入到mysql中后，就会丢失转义符，那么，在读出后，就无法解析为JSON对象了。

例如，如果写入的是JSON字符串：{"a":"ab\"cd"}，这本身是个合法的JSON字符串，可以转换为JSON对象，但是写入mysql后，就会变成：{"a":"ab"cd"}，那么，在进行读出后，就无法转换为JSON对象了。

### 4 html百分号编码和字符实体

第一节和第二节中都是对URL的处理，由于它们对特殊字符的编码的结果是以百分号开头，被称为百分号编码。另外还有一种情形是前端页面对特殊字符的展示：

```html
<input type="text" value="<php echo $name; ?>">
```

在这里，如果name的值是`abc"def`，那么最终在页面上编辑框中显示的就是`abc`，因为里面的双引号已经导致把value属性提前结束了。为了能够正常显示这个双引号，需要在输出这个值时调用htmlentities()函数将字符串转换为HTML实体才能正常显示。这里的HTML实体其实就是为了可以显示空格、引号等特殊字符，对它们也进行的编码，例如：空格就是`&nbsp;`。

#### 所以，百分号编码是为了解决能够正常传输URL提供的解决方案，而字符实体编码是为了解决页面上能够正常显示特殊字符提供的解决方案。

### 5 总结

* 使用js向后台获取数据时，URL中的参数尽量调用encodeURIComponent()进行编码；
* 向后台传递结构复杂的JSON数据时，在js中将JSON对象先转换成JSON字符串，然后再传递给后台；
* 将数据写入mysql数据库时，尽量先调用addslashes()对转义字符再转义一次；
* 使用模版或者PHP直接填充页面字符串时，尽量先将字符串转换为实体编码。

### 参考文档：

1 [url编码(百分号编码)](http://www.cnblogs.com/leaven/archive/2012/07/12/2588746.html)