## nginx

### 0 前言

nginx是一个俄国软件工程师开发的开源的web服务器。自从2004年起，nginx的主要特性是高性能、高并发性和低内存使用率。其它的特性，例如负载均衡、缓存、访问和带宽控制、与其它应用的整合的能力，帮助nginx成为现代网站架构的很好的选择。当前nginx是第二大开源web服务器。

### 1 高并发为何如此重要？

现在网络的发展是如此迅速，十年前，很难想象网络会发展成今天这样。它已经演变到从简单的HTML产生可点击的文本，然后到在apache web服务器，到现在全球超过2亿用户在线的通信媒体。而连接的设备包括PC、手机、tablet，整个互联网正在飞速变化，而整个生态已经走向了数字化。在线服务越来越倾向于生活信息和娱乐。同时，在线业务的安全也发生了巨大的改变。总之，网站比以前更加复杂，通常需要更多的工程上的方法才能变得健壮和可扩展。

网站架构中，最大的挑战之一是并发性。自从网站服务开始，并发性水平就在不断提高。著名的网站服务于成百上千甚至上百万同时在线的用户，这是十分常见的。十年前，并发的主要原因是慢客户端：用户使用ADSL或者拨号上网。现在，并发的原因是有移动客户端和更新的应用程序架构，比较典型的情况是，与服务端保持持久连接，客户端可以更新新闻、推特、朋友的回复等等。提高并发性的另一个重要因素是现代浏览器行为的变化，浏览器会与网站建立4到6个并发连接用于提高网页载入速度。

为了解释慢客户端的问题，想象这样的场景：一个简单的运行在apache上的网站，它产生相对比较短的响应(10KB，一个文本页面或者一个图片)。仅仅需要不到1秒的时间就可以生成或者获取这个页面，但是从服务器端到客户端(带宽是80kbps)的传送花费了10秒。实际上，web服务器可以很快地拉取10KB的内容，在释放掉连接之前，需要花费10秒钟缓慢地将内容发送到客户端。现在，如果有1000个同时连接的客户端都请求类似的内容。每个客户端分配了1MB额外的内存，就需要大约1GB的内存处理1000个客户端的100KB的内容。事实上，基于apache的服务器通常会为每个连接分配超过1MB的额外内存，而且，几十kbps仍然是移动通信的有效速度。虽然在这种场景下可以通过增加操作系统内核的socket缓存进行改善，但是，这不是通用的方法，而且可能会造成不必要的副作用。

对于持久连接，处理并发性的问题更加明显，因为为了避免建立新的HTTP连接的延迟，客户端会保持连接，对于每个连接的客户端，服务器会分配一定的内存。

所以，为了应对持续增长的客户和以此带来的更高级的并发性，网站应该基于多个有效的构建块(efficient building blocks)。另一方面，诸如硬件、网络带宽、应用和数据存储架构也是十分重要的。因此，web服务器应该能够随着并发连接和每秒请求的增长而非线性地扩展。

#### 1.1 难道Apache不合适吗？

今天，Apache仍然占据了互联网的大部分市场份额。起初，它的架构与操作系统和硬件相匹配，那时候的网站通常是运行单个Apache进程的物理服务器。到了20世纪，独立的web服务器模型已经不能够满足持续增长的web服务的需求。虽然Apache为未来的开发提供了坚实的基础，但是，它的架构(产生新的进程处理新的连接)不适合网站的非线性扩展。最终，Apache变成了通用的web服务器，并提供了很多特性：大量第三方扩展，可适用于任何类型的web应用程序开发。然而，由于每个连接的CPU和内存使用率的增加，在单个软件中，拥有如此功能丰富并且通用的工具组合，带来的缺点是较小的可扩展性。

因此，当硬件、操作系统和网络资源不再成为网站扩展的主要限制时，web开发者开始寻找运行web服务器的更好的方式。大约十年前，Daniel Kegel(著名的软件工程师)声称：是时候让web服务器并发处理上万个客户端了，并预言云服务的出现。Kegel提出的C10K让人们试图解决web服务器优化的问题，以便能够并发处理大量客户端，nginx是其中最成功的一个。

为了解决C10K问题，nginx的架构采用不同的思想，在考虑并发连接和请求时，nginx更加适合非线性的扩展性。nginx是基于事件驱动的，不会跟Apache一样针对每个连接产生新的进程。因此，即使负载增肌，内存和CPU的使用率也是可控的。在常用硬件的服务器上运行时，nginx能够处理上万个并发连接。

当第一个版本的nginx发布时，它是同Apache一起部署的，nginx负责处理类似HTML、CSS、Javascript和图像的静态文件，将并发性和时延处理脱离于基于Apache的应用服务器。后来，nginx又添加了用于集成应用的FastCGIA、uswgi和SCGI，以及类似memcached的分布式内存对象缓存系统。还加入了有用的功能：带有负载均衡和缓存的反向代理。这些特性使得nginx成为一个高效的工具组合，可以用于构建可扩展的web基础设施。

